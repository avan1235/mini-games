name: Desktop

on:
  push:
    branches:
      - 'master'
    paths-ignore:
      - '.github/workflows/assemble-android.yml'
      - '.github/workflows/deploy-server.yml'
      - 'android-app/**'
      - 'dev-env/**'
      - 'server/**'
      - 'README.md'

jobs:
  build:
    strategy:
      matrix:
        platform: [ ubuntu-20.04, windows-2019, macos-12 ]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout to push branch
        uses: actions/checkout@master
        with:
          ref: ${{ github.ref }}
      - name: Set up JDK 15
        uses: actions/setup-java@v1
        with:
          java-version: 15
      - name: Build distribution file
        if: job.status == 'success'
        run: |
          export GRADLE_USER_HOME=$(pwd)/.gradle
          export DESKTOP_CLIENT_API_HOST=${{ secrets.API_HOST }}
          export REST_CLIENT_API_SCHEME=https
          export WEBSOCKET_CLIENT_API_SCHEME=wss
          chmod +x ./gradlew
          ./gradlew desktop-app:packageDistributionForCurrentOS
        shell: bash

      - name: Upload deb artifact file to workflow run results
        uses: actions/upload-artifact@v2
        if: hashFiles('desktop-app/build/compose/binaries/main/deb/minigames_1.7.2-1_amd64.deb') != ''
        with:
          name: MiniGames-1.7.2.deb
          path: desktop-app/build/compose/binaries/main/deb/minigames_1.7.2-1_amd64.deb
      - name: Release deb artifact file
        uses: "marvinpinto/action-automatic-releases@latest"
        if: hashFiles('desktop-app/build/compose/binaries/main/deb/minigames_1.7.2-1_amd64.deb') != ''
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          automatic_release_tag: "Linux-MiniGames-1.7.2"
          files: desktop-app/build/compose/binaries/main/deb/minigames_1.7.2-1_amd64.deb

      - name: Upload msi installer file to workflow run results
        uses: actions/upload-artifact@v2
        if: hashFiles('desktop-app/build/compose/binaries/main/msi/MiniGames-1.7.2.msi') != ''
        with:
          name: MiniGames-1.7.2.msi
          path: desktop-app/build/compose/binaries/main/msi/MiniGames-1.7.2.msi
      - name: Release msi installer file
        uses: "marvinpinto/action-automatic-releases@latest"
        if: hashFiles('desktop-app/build/compose/binaries/main/msi/MiniGames-1.7.2.msi') != ''
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          automatic_release_tag: "Windows-MiniGames-1.7.2"
          files: desktop-app/build/compose/binaries/main/msi/MiniGames-1.7.2.msi

      - name: Upload dmg image file to workflow run results
        uses: actions/upload-artifact@v2
        if: hashFiles('desktop-app/build/compose/binaries/main/dmg/MiniGames-1.7.2.dmg') != ''
        with:
          name: MiniGames-1.7.2.dmg
          path: desktop-app/build/compose/binaries/main/dmg/MiniGames-1.7.2.dmg
      - name: Release dmg image file
        uses: "marvinpinto/action-automatic-releases@latest"
        if: hashFiles('desktop-app/build/compose/binaries/main/dmg/MiniGames-1.7.2.dmg') != ''
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          automatic_release_tag: "MacOS-MiniGames-1.7.2"
          files: desktop-app/build/compose/binaries/main/dmg/MiniGames-1.7.2.dmg
